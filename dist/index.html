<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Example of wasm shader runner usage</title>
    
<script type="module" nonce="LkTf21ldTQk3o8FT8AYRvg==">
import init, * as bindings from '/wasm_shader_runner-39d26740ea2fc4f9.js';
const wasm = await init('/wasm_shader_runner-39d26740ea2fc4f9_bg.wasm');


window.wasmBindings = bindings;


dispatchEvent(new CustomEvent("TrunkApplicationStarted", {detail: {wasm}}));

</script>
    <style>
      html {
        width: 100%;
        height: 100%;
      }
      body {
        display: flex;
        flex-direction: column-reverse;
        margin: 0px;
        width: 100%;
        background-color: black;
      }
      canvas {
        background-color: black;
        width: 100vw;
        height: 100vh;
      }
    </style>
  <link rel="modulepreload" href="/wasm_shader_runner-39d26740ea2fc4f9.js" crossorigin=anonymous integrity="sha384-kuZGZm4q+HTRM8tqbwVB+rgBplF6j6jt3aabfFkyQqx7F9gUWfdFANm84HLf9ItB"><link rel="preload" href="/wasm_shader_runner-39d26740ea2fc4f9_bg.wasm" crossorigin=anonymous integrity="sha384-s4dCKl9eI8AQiU4uNaWCUqlHMb1O5H/0Q5wcp2/rWGQg37KbkB3s+xSLxmA16/E9" as="fetch" type="application/wasm"></head>
  <body>
    <div>
      <textarea
        id="input-text"
        rows="20"
        cols="200"
        placeholder="Enter your shader code here..."
      ></textarea>
      <br />
      <button id="send-button">Apply shader code</button>

      <script type="module">
        import {
          set_fragment_shader,
          update_player_state,
        } from "/wasm_shader_runner-39d26740ea2fc4f9.js";

        const sendButton = document.getElementById("send-button");
        const inputText = document.getElementById("input-text");

        inputText.value = "void mainImage(out vec4 fragColor, in vec2 fragCoord)\n\
{\n\
  fragColor = vec4(sin(fragCoord.x/iResolution.x+iTime)/2.0+0.5, sin(fragCoord.y/iResolution.y+iTime)/2.0+0.5, cos(fragCoord.x/iResolution.x+fragCoord.y/iResolution.y+iTime)/2.0+0.5, 1.0);\n\
}";

        sendButton.addEventListener("click", () => {
          const text = inputText.value;
          set_fragment_shader(text);
          console.log("Shader text applied");
        });

        addEventListener("TrunkApplicationStarted", (event) => {
          addEventListener("WasmErrorEvent", (event) => {
            alert("Wasm reported error: " + event.detail);
          });

          const canvas = document.querySelector("canvas");

          let mouse_down = false;
          let down_x = -1;
          let down_y = -1;

          canvas.addEventListener("mousedown", (event) => {
            const rect = canvas.getBoundingClientRect();

            mouse_down = true;
            down_x = event.clientX - rect.left;
            down_y = event.clientY - rect.top;
          });

          canvas.addEventListener("mouseup", (event) => {
            mouse_down = false;
            down_x = -1;
            down_y = -1;
          });

          // Mouse move handler for iMouse uniform
          canvas.addEventListener("mousemove", (event) => {
            if (mouse_down) {
              const rect = canvas.getBoundingClientRect(); // Determine canvas position

              // Relative to canvas coords
              const x = event.clientX - rect.left; // Relative coord X
              const y = event.clientY - rect.top; // Relative coord Y

              update_player_state({ mouse: { x, y, down_x, down_y } }); // pass iMouse values
            }
          });
        });
      </script>
    </div>
  </body>
</html>
